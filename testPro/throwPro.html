<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>세로 게이지 (자동 감소)</title>
  <style>
      body {
          font-family: 'Arial', sans-serif;
          text-align: center;
          padding-top: 50px;
      }

      /* 모달 열기 버튼 스타일 */
      #openModalBtn {
          padding: 10px 20px;
          font-size: 16px;
          background-color: #2196f3;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
      }

      .gauge-container {
          width: 60px;
          height: 300px;
          border: 2px solid #333;
          margin: 0 auto 20px;
          border-radius: 10px;
          background-color: #f1f1f1;
          position: relative;
          overflow: hidden;
      }

      .guide-line {
          position: absolute;
          width: 100%;
          height: 2px;
          background-color: rgba(0, 0, 0, 0.5);
          left: 0;
          z-index: 2; /* 게이지 바보다 위에 있도록 설정 */
      }

      .guide-70 {
          bottom: 70%;
      }

      .guide-90 {
          bottom: 90%;
      }

      .gauge-bar {
          position: absolute;
          bottom: 0;
          width: 100%;
          height: 20%;
          background-color: #4caf50;
          transition: height 0.3s ease;
          z-index: 1; /* 가이드 라인보다 아래 */
      }

      .btn {
          padding: 10px 20px;
          font-size: 16px;
          background-color: #2196f3;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
      }

      .btn:disabled {
          background-color: #aaa;
          cursor: not-allowed;
      }

      .message {
          margin-top: 20px;
          font-size: 18px;
      }

      .visible-modal {
          display: block;
      }
      .hide-modal {
          display: none;
      }

  </style>
</head>
<body>

  <!-- 모달 열기 버튼 -->
  <button id="openModalBtn">낚시 시작하기</button>
  <div id="modal-content">
    <div class="message" id="scoreDisplay">점수: 0점</div>

    <div class="gauge-container">
      <div class="guide-line guide-70"></div>
      <div class="guide-line guide-90"></div>
      <div class="gauge-bar" id="gaugeBar"></div>
    </div>

    <button class="btn" id="clickBtn">클릭!</button>
    <div class="message" id="message"></div>
  </div>
  <script>

    // ======= DOM 가져오기 ======== //
    const gaugeBar = document.getElementById('gaugeBar');
    const message = document.getElementById('message');
    const clickBtn = document.getElementById('clickBtn');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const openModalBtn = document.getElementById('openModalBtn');
    const modalGameContents = document.getElementById('modal-content');


    // ======== 상태관리 변수 및 상수 ======== //
    let score = 0; // 초기 점수

    let currentPercent = 70; // 초기값 20%
    gaugeBar.style.height = `${currentPercent}%`;
    let decreaseTimerId = null;
    let checkCountTimerId = null;

    // ======== 핵심 로직 함수 정의 ========= //


    function updateModalUI() {

      updateGaugeColor(); // 색상 업데이트
    }


    /**
     * @description 현재 게이지에 따라 bar의 색을 바꿔주는 함수
     */
    function updateGaugeColor() {
      if (currentPercent > 90) {
        gaugeBar.style.backgroundColor = '#f44336'; // 빨강
      } else if (currentPercent < 70) {
        gaugeBar.style.backgroundColor = '#ffeb3b'; // 노랑
      } else {
        gaugeBar.style.backgroundColor = '#4caf50'; // 초록 (기본)
      }
    }


    // ======== 실행 코드 ========== //
    updateModalUI();







    // 게임 모달 열기
    openModalBtn.addEventListener('click', e => {
      const isNowHidden = modalGameContents.classList.toggle('hide-modal');
      if (isNowHidden) {
        clearInterval(decreaseTimerId);
        clearInterval(checkCountTimerId);
        decreaseTimerId = null;
        checkCountTimerId = null;
      } else {

      }
    });

    // 좌/우 클릭 번갈아가며 게이지 증가
    clickBtn.addEventListener('mousedown', (e) => {
      e.preventDefault(); // 기본 동작 방지 (특히 우클릭 메뉴)

      // 클릭 순서가 맞을 때만 진행
      if (e.button === expectedClick && currentPercent < 100) {
        currentPercent += 10;
        if (currentPercent > 100) currentPercent = 100;
        gaugeBar.style.height = `${currentPercent}%`;
        updateGaugeColor(); // 색상 업데이트

        // 다음에 눌러야 할 클릭 반전
        expectedClick = expectedClick === 0 ? 2 : 0;

        // 메시지 업데이트
        message.textContent = '';
        if (currentPercent === 100) {
          message.textContent = '물고기가 도망갔어요!';
        }
      }
    });

    // 우클릭 메뉴 막기
    document.addEventListener('contextmenu', (e) => e.preventDefault());

    // 일정 시간마다 5%씩 감소 (1초마다)
    decreaseTimerId = setInterval(() => {
      if (currentPercent > 0 && currentPercent < 100) {
        currentPercent -= 10;
        if (currentPercent < 0) currentPercent = 0;
        gaugeBar.style.height = `${currentPercent}%`;
        updateGaugeColor(); // 색상 업데이트
        message.textContent = '';
      }
    }, 1000);

    // 70~90% 사이에 3초 이상 유지하면 성공
    let successCheckCount = 0;
    let successTriggered = false;




    // 5초 후 게임 종료
    setTimeout(() => {
      // 감소 타이머 멈춤
      clearInterval(decreaseTimerId);

      // 현재 게이지가 70 이상 90 이하 = 성공
      if (currentPercent >= 70 && currentPercent <= 90) {
        score += 30;
      }
    }, 5000);



    checkCountTimerId = setInterval(() => {
      if (currentPercent >= 70 && currentPercent <= 90) {
        successCheckCount++;
        console.log(`카운트: ${successCheckCount}`);
        if (successCheckCount === 6) {
        // if (successCheckCount === 6 && !successTriggered) {
          score += 30;
          successCheckCount = 0;
          console.log('30점 추가');
          scoreDisplay.textContent = `점수: ${score}점`;
          // successTriggered = true;
        }
      } else {
        successCheckCount = 0;
        console.log('카운트 0이 됐음.');
        // successTriggered = false;
      }
    }, 500); // 0.5초마다 체크
  </script>

</body>
</html>